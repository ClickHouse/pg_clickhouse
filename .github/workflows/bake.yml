name: ðŸª Bake Docker Image

on:
  push:

permissions:
  id-token: write
  contents: read
  packages: write

jobs:
  bake:
    name: ðŸª Bake with Postgres ${{ matrix.pgv }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pgv: [18, 17, 16, 15, 14, 13]
    steps:
      - name: Checkout the Repository
        uses: actions/checkout@v4
        with: { submodules: true }
      - name: Set up Depot CLI
        uses: depot/setup-action@v1
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Cache Vendor Build
        uses: actions/cache@v4
        with:
          path: vendor/_build
          key: ${{ runner.os }}-vendor-build
      - name: Set Bake Variables
        run: make bake-vars REGISTRY=ghcr.io/clickhouse PG_VERSIONS=${{ matrix.pgv }} >> $GITHUB_ENV
      - name: Build${{ startsWith(github.ref, 'refs/tags') && ' and Push' || '' }}
        uses: depot/bake-action@v1
        with:
          project: vrpfjb99c5
          platforms: linux/amd64,linux/arm64
          pull: true
          push: ${{ startsWith(github.ref, 'refs/tags') }}
