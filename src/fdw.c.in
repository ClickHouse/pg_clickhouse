/*
	A PostgreSQL function for getting the an environment variable value.
*/

#include "postgres.h"
#include <stdlib.h>
#include "utils/builtins.h"
#include "include/binary.hh"
#include "include/internal.h"
#include "include/fdw.h"
#if PG_VERSION_NUM >= 160000
#include "varatt.h"
#endif

#ifdef PG_MODULE_MAGIC_EXT
PG_MODULE_MAGIC_EXT(.name = "clickhouse_fdw", .version = "__VERSION__");
#else
PG_MODULE_MAGIC;
#endif

ch_connection
chfdw_binary_connect(ch_connection_details *details)
{
	char *ch_error = NULL;
	ch_connection res;
	ch_binary_connection_t *conn = ch_binary_connect(details->host, details->port,
			details->dbname, details->username, details->password, &ch_error);

	if (conn == NULL)
	{
		Assert(ch_error);
		char *error = pstrdup(ch_error);
		free(ch_error);

		ereport(ERROR,
				(errcode(ERRCODE_SQLCLIENT_UNABLE_TO_ESTABLISH_SQLCONNECTION),
				 errmsg("clickhouse_fdw: connection error: %s", error)));
	}

	res.conn = conn;
	// res.methods = &binary_methods;
	res.is_binary = true;
	return res;
}
